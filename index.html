<!DOCTYPE html>
<html lang="en" style="background: #808080;height: 100%;">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8" />
    <title>Experiment</title>
    <script src="jspsych.js" type="text/javascript"></script>
    <script src="plugins/jspsych-brms.js" type="text/javascript"></script>
    <script src="plugins/jspsych-survey-likert.js" type="text/javascript"></script>
    <script src="plugins/jspsych-survey-multi-choice.js" type="text/javascript"></script>
    <script src="plugins/jspsych-survey-multi-select.js" type="text/javascript"></script>
    <script src="plugins/jspsych-survey-text.js" type="text/javascript"></script>
    <script src="plugins/jspsych-instructions.js" type="text/javascript"></script>
    <script src="plugins/jspsych-inattentional-blindness.js" type="text/javascript"></script>
    <script src="plugins/jspsych-attentional_capture.js" type="text/javascript"></script>
    <script src="plugins/jspsych-html-keyboard-response.js" type="text/javascript"></script>
    <script type="text/javascript" src="lib/jspsych-7-pavlovia-2022.1.1.js"></script>
    <link rel="stylesheet" href="css/jspsych.css" type="text/css">

    <script id="functions">
        // Shuffle list function
        function shuffle(array) {
            let currentIndex = array.length,
                randomIndex;

            // While there remain elements to shuffle...
            while (currentIndex != 0) {
                // Pick a remaining element...
                let randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]
                ];
            }

            return array;
        }

        // Downlowd file function
        function download(filename, text) {
            let element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        // Create survey trials add 3 quesions in each trial 
        function getSurveyTrials(survey_type, survey_name, questions, survey_direction, labels) {
            let survey_trials = [];
            for (let i = 0; i < questions.length; i += 3) {
                survey_trials.push({
                    questions: [{
                        labels: labels,
                        prompt: questions[i],
                        required: true
                    }, {
                        labels: labels,
                        prompt: questions[i + 1],
                        required: true
                    }, {
                        labels: labels,
                        prompt: questions[i + 2],
                        required: true
                    }],
                    type: survey_type,
                    direction: survey_direction,
                    name: survey_name + "_" + i
                });
            }
            return survey_trials;
        }

        function getChangeBackgroundColorTrial(color) {
            return {
                type: "html-keyboard-response",
                stimulus: "",
                choices: "NO_KEYS",
                trial_duration: 10,
                on_start: function () {
                    document.getElementsByTagName('body')[0].style.backgroundColor = color;
                }
            };
        }
    </script>

    <script id="rms">
        // Create RMS trials
        function getRmsTrials(images, choices, block) {
            rms_trials = []
            // For each image create RMS trial
            shuffle(images).forEach(element => {
                rms_trials.push({
                    type: "rms",
                    stimulus: element,
                    choices: choices,
                    response_ends_trial: true,
                    post_trial_gap: 400,
                    stimulus_opacity: 0.3,
                    stimulus_block: block
                });
            });

            return rms_trials;
        }

        // Create RMS WHERE trials instructions
        const rms_instructions = {
            pages: [
                "Before this next task starts, please adjust your chair and screen in a way that is convenient to you. <br> Make sure you are about 1 feet away from the screen, and not more than 2 feet (somewhere between 30 and 70 centimeters). <br> If needed, please move your chair/screen closer or further away from you.",
                "The goal of this task is to understand information processing under visual noise. This task will last 7-10 minutes. ",
                "On every round, you will see flashes of colorful squares on the screen, with a '+' sign in the middle of it. <br> Please sit directly in front of the screen (between 30 and 70 centimeters away) and look directly at the '+' sign.",
                "After some time, you will see a face appearing behind the colorful squares. Your task is to indicate whether the face appeared in the left or right side of the screen, as fast as you can. <br> When you see a face through the squares please press 'P' if it appears right to the '+' sign; and 'Q' if it appears left to the '+' sign.",
                "Next, we will have a short training session. Press 'Next' to start.<br> Remember to look directly on the '+' sign during the study. 'P' = Right 'Q' = Left."
            ],
            show_clickable_nav: true,
            type: "instructions",
            direction: "ltr",
            name: "rms_where_instructions"
        };

        // Create RMS WHERE main trials instuctions
        const rms_main_instructions = {
            pages: [
                "The training session is over. Press 'Next' to start the task.<br> Remember to look directly on the '+' sign during the study. <b>'P' = Right 'Q' = Left</b>."
            ],
            show_clickable_nav: true,
            type: "instructions",
            direction: "ltr",
            name: "rms_where_main_instructions"
        };

        //All Practice stimulus
        const practice_images = ["images/rms/f42887_e_001.jpg",
            "images/rms/f42887_e_001.jpg", "images/rms/f42887_e_001.jpg", "images/rms/f42887_e_001.jpg",
            "images/rms/f42887_e_001.jpg", "images/rms/f42887_e_001.jpg", "images/rms/f42887_e_001.jpg",
            "images/rms/f42887_e_001.jpg", "images/rms/f42887_e_001.jpg", "images/rms/f42887_e_001.jpg"
        ];

        // All main task stimulus, not reverted
        const main_images = [
            "images/rms/f42887_e_001.jpg", "images/rms/f42887_e_005.jpg", "images/rms/f42887_e_015.jpg",
            "images/rms/f42887_e_025.jpg", "images/rms/f42887_e_028.jpg", "images/rms/f42887_e_053.jpg",
            "images/rms/f42887_e_058.jpg", "images/rms/f42887_e_064.jpg", "images/rms/f42887_e_072.jpg",
            "images/rms/f42887_e_080.jpg", "images/rms/f42887_e_098.jpg", "images/rms/f42887_e_103.jpg",
            "images/rms/f42887_e_121.jpg", "images/rms/f42887_e_127.jpg", "images/rms/f42887_e_140.jpg",
            "images/rms/f42887_e_156.jpg", "images/rms/f42887_e_161.jpg", "images/rms/f42887_e_180.jpg",
            "images/rms/f42887_e_202.jpg", "images/rms/f42887_e_241.jpg", "images/rms/f42887_e_245.jpg"
        ];

        // All main task stimulus, reverted
        const reverted_main_images = [
            "images/rms/f42887_e_001_1.jpg", "images/rms/f42887_e_005_1.jpg", "images/rms/f42887_e_015_1.jpg",
            "images/rms/f42887_e_025_1.jpg", "images/rms/f42887_e_028_1.jpg", "images/rms/f42887_e_053_1.jpg",
            "images/rms/f42887_e_058_1.jpg", "images/rms/f42887_e_064_1.jpg", "images/rms/f42887_e_072_1.jpg",
            "images/rms/f42887_e_080_1.jpg", "images/rms/f42887_e_098_1.jpg", "images/rms/f42887_e_103_1.jpg",
            "images/rms/f42887_e_121_1.jpg", "images/rms/f42887_e_127_1.jpg", "images/rms/f42887_e_140_1.jpg",
            "images/rms/f42887_e_156_1.jpg", "images/rms/f42887_e_161_1.jpg", "images/rms/f42887_e_180_1.jpg",
            "images/rms/f42887_e_202_1.jpg", "images/rms/f42887_e_241_1.jpg", "images/rms/f42887_e_245_1.jpg"
        ];

        // Choices for RMS trials (q for left and p for right)
        const choices = ["q", "p"];

        function get_rms_trials(test = false) {
            // Create RMS timeline
            let rms_trials = [];

            // Add Rms instructions
            rms_trials.push(rms_instructions);

            // Create all RMS practice trials
            const rms_training_trials = getRmsTrials(practice_images, choices, "training");

            // Add all practice trials to RMS timeline in random order (using shuffle function)
            shuffle(rms_training_trials).forEach(function (trial) {
                rms_trials.push(trial);
            });

            // Add RMS instuctions (for main trials)
            rms_trials.push(rms_main_instructions);

            // Create all RMS main trials (reverted and not reverted together)
            const main_rms_trials = getRmsTrials(main_images, choices, "main").concat(
                getRmsTrials(reverted_main_images, choices, "reversed"));

            if (test) {
                shuffle(main_rms_trials).slice(0, 10).forEach(function (trial) {
                    rms_trials.push(trial);
                });
            } else {
                shuffle(main_rms_trials).forEach(function (trial) {
                    rms_trials.push(trial);
                });
            }

            return rms_trials;
        }
    </script>

    <script id="attentional-capture">
        const attentional_capture_training_instructions = {
            pages: [
                "Attentional capture training instructions"
            ],
            show_clickable_nav: true,
            type: "instructions",
            direction: "ltr",
            name: "attentional_capture_training_instructions",
            on_finish: function () {
                document.getElementsByTagName('body')[0].style.backgroundColor = 'black';
            }
        };

        const attentional_capture_instructions = {
            pages: [
                "Attentional capture instructions"
            ],
            show_clickable_nav: true,
            type: "instructions",
            direction: "ltr",
            name: "attentional_capture_instructions",
            on_finish: function () {
                document.getElementsByTagName('body')[0].style.backgroundColor = 'black';
            }
        };

        function getSingleAttentionalCaptureTrial(singelton_exist, color, distractor_color, distractors_shapes) {
            return {
                type: 'attentional-capture',
                target_shape: "circle",
                color: color,
                distractor_exist: singelton_exist,
                distractor_shapes: distractors_shapes,
                distractor_color: distractor_color,
                set_size: 8
            };
        }

        function getDistractorColor(color) {
            if (color == "red") {
                return "green";
            } else {
                return "red";
            }
        }

        function get_attentional_capture_trials(test = false) {
            let training_count;
            let main_with_distractor_count;
            let main_without_distractor_count;
            let colors;
            const distractors_shapes_list = ["diamond", "square", "triangle"];

            if (test) {
                training_count = 2;
                main_with_distractor_count = 2;
                main_without_distractor_count = 2;
            } else {
                training_count = 12;
                main_with_distractor_count = 148;
                main_without_distractor_count = 140;
            }

            const main_count = main_with_distractor_count + main_without_distractor_count;

            colors = [];
            for (let i = 0; i < training_count + main_count; i++) {
                if (i % 2 == 0) {
                    colors.push("red");
                } else {
                    colors.push("green");
                }
            }

            colors = shuffle(colors);

            let training_trials = [];

            for (let i = 0; i < training_count; i++) {
                training_trials.push(getSingleAttentionalCaptureTrial(false, colors[i], getDistractorColor(colors[i]), ["circle", "square", "triangle"]));
            }

            let main_trials = [];

            for (let i = training_count; i < main_with_distractor_count + training_count; i++) {
                if (i % 2 == 0) {
                    main_trials.push(getSingleAttentionalCaptureTrial(true, colors[i], getDistractorColor(colors[i]), distractors_shapes_list));
                } else {
                    main_trials.push(getSingleAttentionalCaptureTrial(true, colors[i], getDistractorColor(colors[i]), [shuffle(distractors_shapes_list)[0]]));
                }
            }

            for (let i = main_with_distractor_count + training_count; i < training_count + main_count; i++) {
                if (i % 2 == 0) {
                    main_trials.push(getSingleAttentionalCaptureTrial(false, colors[i], getDistractorColor(colors[i]), distractors_shapes_list));
                } else {
                    main_trials.push(getSingleAttentionalCaptureTrial(false, colors[i], getDistractorColor(colors[i]), [shuffle(distractors_shapes_list)[0]]));
                }
            }

            return [
                attentional_capture_training_instructions,
                getChangeBackgroundColorTrial("black"),
                ...shuffle(training_trials),
                getChangeBackgroundColorTrial("#808080"),
                attentional_capture_instructions,
                getChangeBackgroundColorTrial("black"),
                ...shuffle(main_trials),
                getChangeBackgroundColorTrial("#808080"),
            ]
        }
    </script>

    <script id="inattentional-blindness">
        const inattentional_blindness_start_instructions = {
            pages: [
                "In this task, you will be presented with 4 Black letters and 4 White letters, as well as a blue line with a square in the center.",
                "The letters will move about the display at various speeds.",
                "Your task will be to count the number of times the White letters completely cross the blue line.",
                "Please keep your eyes on the blue square while you complete this task.",
                "In order for this task to run at the highest quality possible, it is very important that you close any other open browser tabs or windows.",
                "Please do this now before you start the task.",
                "Press the next to begin."
            ],
            show_clickable_nav: true,
            type: "instructions",
            direction: "ltr",
            name: "ib_start_instructions"
        };

        const inattentional_blindness_trial_instructions = {
            pages: [
                "Please count the number of times the White letters completely cross the blue line.",
                "Do not include the line crossings you counted in the prevous trial in your count for this trial.",
                "Remember to keep your eyes on the blue square while you complete this task.",
                "Press the next to begin."
            ],
            show_clickable_nav: true,
            type: "instructions",
            direction: "ltr",
            name: "ib_instructions"
        }

        const inattentional_blindness_question = {
            type: "survey-text",
            name: "ib_question",
            questions: [
                {
                    prompt: "How many times did the White letters completely cross the blue line?",
                    name: "count_question"
                }
            ]
        };

        function get_intattentional_blindness_trials(target_position) {
            let inattentional_blindness_trials = [];

            inattentional_blindness_trials.push(inattentional_blindness_start_instructions);


            for (let i = 0; i < 4; i++) {
                inattentional_blindness_trials.push(inattentional_blindness_trial_instructions);
                inattentional_blindness_trials.push({
                    type: "inattentional-blindness",
                    show_target: false,
                });
                name = "ib_trial_" + i;
                inattentional_blindness_trials.push(inattentional_blindness_question)
            }

            target_trial = {
                type: "inattentional-blindness",
                show_target: true,
                target_position: target_position,
                name: "ib_target_trial"
            };

            inattentional_blindness_trials.push(target_trial);

            return inattentional_blindness_trials;
        }
    </script>

    <script id="pavlovia">
        // Pavlovia
        const pavlovia_init = {
            type: "pavlovia",
            command: "init"
        };

        const pavlovia_finish = {
            type: "pavlovia",
            command: "finish"
        };
    </script>

    <script id="general">
        // Create start experiment trials
        const start = [pavlovia_init, {
            pages: [
                "You are invited to participate in web-based research of meaningful perception. the experiment will take approximately X minutes to complete. <br><br><b>PARTICIPATION</b><br>Your participation in this survey is voluntary. You may refuse to take part in the research or exit the survey at any time.<br><br><b>BENEFITS</b><br>You will be compensated X USD for participation in this study. <br>Although this study will not benefit you personally, we hope that our results will add to the knowledge about human experiences.",
                "<b>RISKS</b><br>There are no foreseeable risks involved in participating in this study other than those encountered in standard use of the device you use to access the survey (computer, smartphone, etc.).<br>Your participation in this study will not include psychological counseling. In the event you seek such services, please contact the center below:<br>National Hopeline Network 1-800-784-2433<br><br><b>CONFIDENTIALITY</b><br>All of your responses will be held in confidence. Only the researchers involved in this study and those responsible for research oversight will have access to the information you provide.<br>The researcher will not know your name, and no identifying information will be connected to your survey answers in any way. The survey is therefore anonymous.",
                "<b>CONTACT</b><br>If you have questions at any time about the study or the procedures, you may contact the researcher, Nadav Weisler via email at nadav.weisler1@mai.huji.ac.il<br><br><b>ELECTRONIC CONSENT:</b><br> Please note - clicking on the “Next >” button indicates that:<br>•You have read the above information<br>• You voluntarily agree to participate<br>• You are 18 years of age or older<br>If you do not want to participate please close the window. Your data will not be used either way.",
                "We are about to begin. First, please answer the next few questions regarding demographic information."
            ],
            show_clickable_nav: true,
            type: "instructions",
            direction: "ltr",
            name: "gender_instructions"
        }, {
                questions: [{
                    options: ["Male", "Female", "Other"],
                    prompt: "What gender do you identify as?",
                    required: true
                }, {
                    options: ["Right", "Left", "I don't know"],
                    prompt: "What is your dominant hand?",
                    required: true
                }],
                type: "survey-multi-choice",
                direction: "ltr",
                name: "question_start_1"
            }, {
                questions: [{
                    rows: 1.0,
                    columns: 2.0,
                    value: "",
                    prompt: "What is your age?",
                    required: true
                }],
                type: "survey-text",
                direction: "ltr",
                name: "age_q"
            }, {
                questions: [{
                    rows: 1.0,
                    columns: 25.0,
                    value: "",
                    prompt: "Please enter your mTurk ID.<br>Note, that if you don't include your mTurk ID, we may not be able to compensate you:",
                    required: true
                }],
                type: "survey-text",
                direction: "ltr",
                name: "id"
            }, {
                questions: [{
                    options: ["Yes", "No"],
                    prompt: "Have you ever been officially diagnosed with ADD / ADHD?",
                    required: true
                }],
                type: "survey-multi-choice",
                direction: "ltr",
                name: "attention_1"
            }, {
                questions: [{
                    labels: ["1", "2", "3", "4", "5", "6", "7"],
                    prompt: "If you did not officially diagnosed with ADD / ADHD, what is your suspicion level that you have ADD / ADHD?, " +
                        "where 1 is \"I am sure I don't have ADD / ADHD\" and 7 is \"I am sure I have ADD / ADHD\".<br>" +
                        "If you were officially diagnosed with ADD / ADHD, please select 1.",
                    required: true
                }],
                type: "survey-likert",
                direction: "ltr",
                name: "attention_2"
            }, {
                questions: [{
                    options: ["High school", "Bachelor's Degree", "Master's Degree", "Ph.D.", "Trade school", "Prefer not to answer"],
                    prompt: "What is the highest degree or level of education you have completed?",
                    required: true
                }],
                type: "survey-multi-choice",
                direction: "ltr",
                name: "education"
            }];

        // Create end experimnt trials
        const end = [{
            questions: [{
                labels: [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5"
                ],
                prompt: "מ-1 עד-5, עד כמה הייתה ברורה לך המטלה עם הריבועים המרצדים?",
                required: true
            }],
            type: "survey-likert",
            direction: "rtl",
            name: "LAST_1"
        }, {
            questions: [{
                options: [
                    "כן",
                    "לא"
                ],
                prompt: "האם הייתה לך איזושהי אסטרטגיה?",
                required: true
            }],
            type: "survey-multi-choice",
            direction: "rtl",
            name: "LAST_2"
        }, {
            questions: [{
                rows: 7.0,
                columns: 7.0,
                value: "",
                prompt: "אם כן, מהי?",
                required: true
            }],
            type: "survey-text",
            name: "LAST_3"
        }, {
            questions: [{
                labels: [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5"
                ],
                prompt: "מ-1 עד-5, עד כמה הייתה ברורה לך המטלה בה היית צריכה להקיש למראה ריבוע אדום?",
                required: true
            }],
            type: "survey-likert",
            direction: "rtl",
            name: "LAST_4"
        }, {
            questions: [{
                options: [
                    "כן",
                    "לא"
                ],
                prompt: "האם הייתה לך איזושהי אסטרטגיה?",
                required: true
            }],
            type: "survey-multi-choice",
            direction: "rtl",
            name: "LAST_5"
        }, {
            questions: [{
                rows: 7.0,
                columns: 7.0,
                value: "",
                prompt: "אם כן, מהי?",
                required: true
            }],
            type: "survey-text",
            name: "LAST_6"
        }, {
            questions: [{
                labels: [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5",
                    "6",
                    "7"
                ],
                prompt: "בהשוואה לנהגת הממוצעת, כיצד היית מגדירה את הנהיגה שלך? כך ש-1 אומר הרבה מתחת לממוצע ו-7 אומר הרבה מעבר לממוצע?",
                required: false
            }],
            type: "survey-likert",
            direction: "rtl",
            name: "DRIVE_1"
        }, {
            questions: [{
                rows: 2.0,
                columns: 1.0,
                value: "",
                prompt: "להערכתך, בכמה תאונות דרכים היית מעורבת <bold> כנהגת </bold> במהלך שלושת השנים האחרונות כולל תאונות קטנות וללא נזק",
                required: false
            }],
            type: "survey-text",
            name: "DRIVE_2"
        }, {
            questions: [{
                rows: 2.0,
                columns: 1.0,
                value: "",
                prompt: "להערכתך, בכמה תאונות דרכים היית מעורבת <bold> כהולכת רגל </bold> במהלך שלושת השנים האחרונות כולל תאונות קטנות וללא נזק",
                required: true
            }],
            type: "survey-text",
            name: "WALK"
        }, pavlovia_finish, {
            pages: [
                "תודה שהשתתפת בניסוי, לחצי על המשך לסיום הניסוי."
            ],
            show_clickable_nav: true,
            type: "instructions",
            direction: "rtl",
            name: "end_instructions"
        }];        
    </script>

    <script id="run">
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        console.log(urlParams.get('test'));

        const test_run = urlParams.get('test') == "true";

        let rms_trials;
        let ac_trials;
        if (test_run) {
            rms_trials = get_rms_trials(test_run);
            ac_trials = get_attentional_capture_trials(test_run);
        } else {
            rms_trials = get_rms_trials();
            ac_trials = get_attentional_capture_trials();
        }

        let main_trials = []
        shuffle([ac_trials, rms_trials]).forEach(trials => {
            main_trials.push(...trials);
        });

        const ib_trials = get_intattentional_blindness_trials("pvfar");

        const experiment_timeline = [
            ...start,
            ...main_trials,
            ...ib_trials,
            ...end
        ]

        jsPsych.init({
            timeline: experiment_timeline,
            fullscreen: true,
            on_finish: function () {
                console.log("Finished");
            }
        });
    </script>
</head>

</html>